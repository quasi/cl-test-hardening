# Generator Protocol

**Status**: stable
**Package**: `th.gen`
**Source**: `src/property/package.lisp:50-76`, `generators/primitives.lisp`

## Overview

Generators produce random test data for property-based testing. The generator protocol defines how to create, generate values, and shrink failing cases.

## Core Protocol

### Generator Class

```lisp
(defclass generator ()
  ((name :initarg :name :reader generator-name)))
```

All generators inherit from this base class.

### Generate Method

```lisp
(defgeneric generate (generator random-state size) => value)
```

**Purpose**: Generate a random value.

**Parameters**:
- `generator`: Generator instance
- `random-state`: Random state for reproducibility
- `size`: Complexity hint (typically 0-100)

**Returns**: A generated value appropriate for the generator type.

**Contract**:
- MUST use the provided `random-state` for all randomness
- MUST respect the `size` parameter as a complexity hint
- MUST return a value of the expected type

### Shrink Method

```lisp
(defgeneric shrink (generator value) => (list-of smaller-values))
```

**Purpose**: Generate smaller/simpler variants of a failing test case.

**Parameters**:
- `generator`: Generator instance
- `value`: A value that caused a test failure

**Returns**: List of simpler values to try (can be empty).

**Contract**:
- MUST return a list (even if empty)
- SHOULD return simpler values than the input
- SHOULD order results from simplest to most complex
- MAY return empty list if no shrinking possible

## Primitive Generators

### integers

```lisp
(defun integers (&key min max) => generator)
```

**Purpose**: Generate integers in a range.

**Parameters**:
- `min`: Minimum value (default: `-size`)
- `max`: Maximum value (default: `size`)

**Returns**: Integer generator.

**Examples**:
```lisp
(integers)              ; Range depends on size
(integers :min 0)       ; Non-negative integers
(integers :min 1 :max 10) ; 1 to 10 inclusive
```

**Shrinking**: Toward zero.

---

### naturals

```lisp
(defun naturals (&key max) => generator)
```

**Purpose**: Generate non-negative integers.

**Parameters**:
- `max`: Maximum value (default: `size`)

**Returns**: Natural number generator.

**Contract**: Always generates `n >= 0`.

**Shrinking**: Toward zero, negative values filtered.

---

### floats

```lisp
(defun floats (&key (min 0.0) (max 1.0)) => generator)
```

**Purpose**: Generate floating-point numbers.

**Parameters**:
- `min`: Minimum value (default: `0.0`)
- `max`: Maximum value (default: `1.0`)

**Returns**: Float generator.

**Contract**: Generates `f` where `min <= f < max`.

**Shrinking**: Toward zero.

---

### booleans

```lisp
(defun booleans () => generator)
```

**Purpose**: Generate boolean values (`t` or `nil`).

**Returns**: Boolean generator.

**Shrinking**: `t` shrinks to `nil`.

---

### characters

```lisp
(defun characters (&key alphabet) => generator)
```

**Purpose**: Generate characters from an alphabet.

**Parameters**:
- `alphabet`: String of allowed characters (default: alphanumeric)

**Returns**: Character generator.

**Shrinking**: Toward `#\a`.

---

### strings

```lisp
(defun strings (&key (min-length 0) max-length alphabet) => generator)
```

**Purpose**: Generate strings.

**Parameters**:
- `min-length`: Minimum string length (default: `0`)
- `max-length`: Maximum string length (default: size-dependent)
- `alphabet`: Characters to use (default: lowercase letters)

**Returns**: String generator.

**Contract**:
- Generated strings have length between `min-length` and `max-length`
- Characters come from `alphabet`

**Shrinking**: Toward empty string, then simpler characters.

---

### symbols

```lisp
(defun symbols (&key package) => generator)
```

**Purpose**: Generate symbols.

**Parameters**:
- `package`: Package for symbols (default: `*package*`)

**Returns**: Symbol generator.

**Contract**: Symbols are interned in the specified package.

**Shrinking**: Toward shorter names.

---

### keywords

```lisp
(defun keywords () => generator)
```

**Purpose**: Generate keywords.

**Returns**: Keyword generator.

**Contract**: All symbols in the `:keyword` package.

**Shrinking**: Toward shorter names.

## Collection Generators

### lists

```lisp
(defun lists (element-generator &key min-length max-length) => generator)
```

**Purpose**: Generate lists of elements.

**Parameters**:
- `element-generator`: Generator for list elements
- `min-length`: Minimum list length (default: `0`)
- `max-length`: Maximum list length (default: size-dependent)

**Returns**: List generator.

**Contract**: Each element generated by `element-generator`.

---

### vectors

```lisp
(defun vectors (element-generator &key min-length max-length) => generator)
```

**Purpose**: Generate vectors of elements.

**Parameters**: Same as `lists`.

**Returns**: Vector generator.

---

### hash-tables

```lisp
(defun hash-tables (key-generator value-generator &key min-size max-size) => generator)
```

**Purpose**: Generate hash tables.

**Parameters**:
- `key-generator`: Generator for keys
- `value-generator`: Generator for values
- `min-size`: Minimum number of entries
- `max-size`: Maximum number of entries

**Returns**: Hash table generator.

## Combinators

### one-of

```lisp
(defun one-of (&rest generators) => generator)
```

**Purpose**: Choose randomly from multiple generators.

**Contract**: Uniform random selection.

---

### frequency

```lisp
(defun frequency (&rest weighted-generators) => generator)
```

**Purpose**: Choose from generators with weighted probabilities.

**Parameters**: Pairs of `(weight generator)`.

**Example**:
```lisp
(frequency 8 (integers) 2 (floats)) ; 80% integers, 20% floats
```

---

### such-that

```lisp
(defun such-that (predicate generator &key max-tries) => generator)
```

**Purpose**: Filter generated values by predicate.

**Parameters**:
- `predicate`: Test function
- `generator`: Base generator
- `max-tries`: Maximum generation attempts (default: 100)

**Contract**: Throws error if `max-tries` exceeded.

---

### tuple

```lisp
(defun tuple (&rest generators) => generator)
```

**Purpose**: Generate fixed-size tuples.

**Returns**: List with one value from each generator.

**Example**:
```lisp
(tuple (integers) (strings) (booleans)) ; => (42 "hello" t)
```

---

### fmap

```lisp
(defun fmap (function generator) => generator)
```

**Purpose**: Transform generated values.

**Parameters**:
- `function`: Transformation function
- `generator`: Base generator

**Example**:
```lisp
(fmap #'abs (integers)) ; Absolute values only
```

---

### const

```lisp
(defun const (value) => generator)
```

**Purpose**: Always generate the same value.

---

### elements

```lisp
(defun elements (list) => generator)
```

**Purpose**: Choose randomly from a list of values.

## Size Control

### resize

```lisp
(defun resize (new-size generator) => generator)
```

**Purpose**: Override the size parameter.

---

### sized

```lisp
(defun sized (function) => generator)
```

**Purpose**: Create generator with explicit size dependency.

**Parameters**:
- `function`: `(lambda (size) generator)` - receives size, returns generator

## Reproducibility

**Contract**: All generators MUST use the provided `random-state` parameter. This ensures:
- Tests are reproducible given a seed
- Counterexamples can be replayed
- Shrinking is deterministic

## References

- Implementation: `generators/primitives.lisp`, `generators/collections.lisp`, `generators/combinators.lisp`
- Package: `src/property/package.lisp`
- Tests: `tests/generator-tests.lisp`
